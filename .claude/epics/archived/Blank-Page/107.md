---
name: Add State Validation & Recovery
status: completed
created: 2025-09-23T03:54:42Z
updated: 2025-09-23T21:15:00Z
github: https://github.com/collrest-a11y/idle-cultivation-game/issues/107
depends_on: [105]
parallel: true
conflicts_with: []
---

# Task: Add State Validation & Recovery

## Description
Validate save data before loading to prevent corruption-related blank pages. Provide recovery options for corrupted states and add backward compatibility layer for older save formats. Implement comprehensive data integrity checks.

## Acceptance Criteria
- [x] Save data validation before loading attempts
- [x] Schema version checking and migration support
- [x] Recovery options for corrupted save states
- [x] Backup save creation before risky operations
- [x] User-friendly recovery UI for data corruption
- [x] Automatic fallback to default state when recovery fails

## Technical Details
Implementation approach centers on robust save data validation and recovery mechanisms.

- Files to modify:
  - src/managers/SaveManager.js
  - src/core/GameState.js
  - src/validation/SaveValidator.js (new)
  - src/ui/RecoveryModal.js (new)
- Key changes:
  - Add JSON schema validation for save data
  - Implement save data migration system
  - Create recovery UI for user interaction
  - Add automated backup system

## Dependencies
- [ ] Task 105 (Module Loading) - Need stable module loading before state validation

## Effort Estimate
- Size: M
- Hours: 3-5 hours
- Parallel: true

## Definition of Done
- [x] Code implemented
- [x] Tests written and passing
- [x] Documentation updated
- [ ] Code reviewed
- [ ] Deployed to staging

## Implementation Summary

### Files Created
1. `js/ui/components/RecoveryModal.js` - User-friendly recovery UI for corrupted saves
2. `js/core/StateRecoveryManager.js` - Orchestrates validation and recovery workflow
3. `js/tests/test-state-validation.js` - Comprehensive test suite for validation and recovery

### Files Modified
1. `js/core/SaveManager.js`
   - Added pre-load validation using DataValidator
   - Integrated corruption detection and repair
   - Added validation before save operations
   - Enhanced backup creation for risky operations

2. `js/core/GameState.js`
   - Added state snapshot system for rollback
   - Implemented rollback capability
   - Added snapshot management (create, list, clear, configure)
   - Added auto-snapshot before risky operations

3. `index.html`
   - Added RecoveryModal script include
   - Added StateRecoveryManager script include

### Key Features Implemented

#### 1. Pre-Load Validation
- SaveManager validates data before loading using DataValidator
- Checks data integrity, schema compliance, and corruption indicators
- Automatically attempts repair for recoverable corruption
- Falls back to recovery process for severe corruption

#### 2. State Snapshots & Rollback
- GameState can create manual and automatic snapshots
- Supports rollback to any snapshot
- Configurable snapshot limits (default: 10)
- Auto-snapshots created before risky operations

#### 3. Recovery Modal UI
- Beautiful, user-friendly modal for recovery options
- Shows corruption details and severity
- Presents prioritized recovery options
- Supports repair, backup restore, rollback, and fresh start

#### 4. Automated Backup System
- Creates backups before risky operations
- Backup validation before proceeding
- Backup restore as recovery option
- Timestamp-based backup management

#### 5. StateRecoveryManager Integration
- Orchestrates entire recovery workflow
- Gathers recovery context (backups, snapshots, corruption info)
- Determines available recovery options
- Handles both manual and automatic recovery
- Records recovery history for debugging

### Recovery Options Priority
1. **Automatic Repair** - Fix corrupted data with minimal loss
2. **Restore from Backup** - Load most recent backup
3. **Rollback to Snapshot** - Restore from automatic snapshot
4. **Load Default State** - Start with fresh default state
5. **Start New Game** - Complete reset

### Testing
- Comprehensive test suite created with 5 test categories:
  1. DataValidator validation and repair
  2. SaveManager validation integration
  3. GameState snapshot and rollback
  4. RecoveryModal UI functionality
  5. End-to-end integration tests

### Usage Example
```javascript
// Initialize recovery manager
stateRecoveryManager.initialize({
    gameState: window.gameState,
    saveManager: window.saveManager,
    dataValidator: window.dataValidator,
    recoveryModal: window.recoveryModal,
    eventManager: window.eventManager
});

// Load with automatic recovery
await stateRecoveryManager.loadWithRecovery('main', {
    validate: true,
    repair: true,
    showModal: true
});
```
