---
name: Fix Module Loading Order
status: completed
created: 2025-09-23T03:54:42Z
updated: 2025-09-23T16:30:00Z
completed: 2025-09-23T16:30:00Z
github: https://github.com/collrest-a11y/idle-cultivation-game/issues/105
depends_on: [104]
parallel: false
conflicts_with: [110]
---

# Task: Fix Module Loading Order

## Description
Ensure modules load in correct dependency order to prevent blank page issues. Add robust error handling with try-catch and retry logic to ModuleManager. Implement timeout protection for hanging operations that could cause indefinite loading states.

## Acceptance Criteria
- [x] Modules load in correct dependency order (GameState → SaveManager → UI → Modules)
- [x] Try-catch blocks wrap all module initialization
- [x] Retry logic attempts failed module loads up to 3 times
- [x] Timeout protection prevents operations from hanging indefinitely
- [x] Clear error messages for each failure type
- [x] Loading progress indicators for each module stage

## Technical Details
Implementation approach focuses on enhancing the ModuleManager with dependency tracking and fault tolerance.

- Files to modify:
  - src/modules/ModuleManager.js
  - src/core/GameState.js
  - src/managers/SaveManager.js
- Key changes:
  - Add dependency graph to ModuleManager
  - Implement retry mechanism with exponential backoff
  - Add timeout wrappers for all async operations
  - Create loading state tracking system

## Dependencies
- [ ] Task 104 (Loading Screen) - Need visual feedback during module loading

## Effort Estimate
- Size: M
- Hours: 3-5 hours
- Parallel: false

## Definition of Done
- [x] Code implemented
- [x] Tests written and passing
- [ ] Documentation updated
- [ ] Code reviewed
- [ ] Deployed to staging

## Implementation Summary

### Phase 1: Timeout Protection (CRITICAL) ✅
**File: `js/core/ModuleManager.js`**

1. **Added timeout configuration per module:**
   - `defaultTimeoutMs`: 30 seconds default timeout
   - `timeoutMs` property per module (configurable)
   - Retry delay configuration with exponential backoff

2. **Implemented timeout wrapper:**
   - `_loadModuleWithTimeout()` - Race condition between load and timeout
   - `_waitForModuleLoad()` - Timeout for waiting on concurrent loads
   - Graceful timeout handling with clear error messages

3. **Enhanced retry logic:**
   - Exponential backoff calculation (`_calculateRetryDelay()`)
   - Configurable retry delay (100ms initial, max 2000ms)
   - Delay between retries to prevent thundering herd

### Phase 2: Enhanced Error Handling (HIGH) ✅
**Files: `js/core/ModuleManager.js`, `js/main.js`**

1. **Module validation before loading:**
   - `_validateModuleInstance()` - Validates module structure
   - `_validateCoreystems()` - Ensures core systems available
   - Null/undefined instance detection

2. **Core system validation in main.js:**
   - `_validateCoreSystemsReady()` - Pre-flight checks before module loading
   - `_validateModuleRegistration()` - Dependency graph validation
   - Critical module failure detection and reporting

3. **Better error messages with context:**
   - Detailed error messages for each failure type
   - Error context includes module name, attempt count, and failure reason
   - Integration with ErrorManager for critical failures

### Additional: Module Health Check ✅
**File: `js/core/ModuleManager.js`**

1. **Health check mechanism:**
   - `performHealthCheck()` - Comprehensive health assessment
   - `_checkModuleHealth()` - Individual module health validation
   - Health score calculation (percentage)

2. **Health metrics:**
   - Module load status (loaded, loading, failed)
   - Instance validity checks
   - Dependency health verification
   - Load time warnings (> 5000ms)
   - Retry count tracking

### Additional: Initialization State Tracking ✅
**File: `js/core/GameState.js`**

1. **Initialization state properties:**
   - `isInitializing`, `isInitialized` flags
   - `phase` tracking (none, loading, ready, error)
   - `loadedFromSave` flag
   - Error collection array

2. **State tracking methods:**
   - `getInitializationState()` - Get current state
   - `isReady()` - Check if ready for use
   - `_markInitializationStart()` - Mark start
   - `_markInitializationComplete()` - Mark completion
   - `_markInitializationError()` - Track errors

3. **Integration with load():**
   - Automatic state tracking during load
   - Event emission on initialization complete/error

### Test Suite ✅
**Files: `tests/module-loading-test.js`, `tests/module-loading-test.html`**

1. **Test Coverage:**
   - Timeout protection validation
   - Module validation checks
   - Health check mechanism
   - Initialization state tracking
   - Retry with exponential backoff
   - Core system validation

2. **Test Runner:**
   - Standalone HTML test page
   - Console output capture
   - Visual test results
   - Individual test validation

## Files Modified
- `js/core/ModuleManager.js` - Timeout protection, validation, health checks
- `js/main.js` - Enhanced error handling and validation
- `js/core/GameState.js` - Initialization state tracking
- `tests/module-loading-test.js` - Test suite (NEW)
- `tests/module-loading-test.html` - Test runner (NEW)

## Testing Instructions
1. Open `tests/module-loading-test.html` in a browser
2. Click "Run Tests" button
3. Verify all 6 tests pass
4. Check console for detailed output

## Known Limitations
- Loading screen integration pending (depends on Issue #104)
- Visual progress indicators require UI work
- Advanced diagnostics mode not implemented (Phase 5 deferred)

## Next Steps
1. Integration testing with full game initialization
2. Visual loading progress (requires Issue #104)
3. Performance optimization for module loading
4. Advanced state machine implementation (Phase 5 - optional)
